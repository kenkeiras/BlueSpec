(ql:quickload "cl-html5-parser")
(ql:quickload "cl-fad")

(use-package :html5-parser)
(use-package :cl-fad)


(defvar *LINK-TABLE* (make-hash-table :test #'equalp))


(defparameter *UNDERLINES* "=-;:_.,\"'")

(defclass spec-page()
  ((title :accessor title)
   (rst :accessor rst)
   (links :accessor links)
   (raw :accessor raw)
   (toctreep :accessor toctreep)
   ))




(defmethod initialize-instance :after ((page spec-page)
                                       &key ((:content content)))
  (setf (raw page) content)

  (let ((title (get-text (car (get-in-toplevel content "h2")))))
    (setf (title page)
          (strip (first
                  (flatten
                   (list
                    (if title title
                        (subseq
                         (caddr (car (get-in-toplevel content "title")))
                         6))))))))

  (let ((restructured (flatten (xmls-to-rst (get-content content)
                                            (read-title-index (title page))))))
    (setf (toctreep page) (every (lambda (X) (or (includep X)
                                                 (= (length X) 0)))
                                 (mapcar #'strip restructured)))
    (setf (rst page) (format NIL "狺ア蝈篝蝓泗躜邃┅Ж麒孱戾铉翳蝈徜糸綮瀛轭溴糸綮疳珏┅博ㄦ矧磲狺ア糸綮疳珏┅┅ㄤ彐躅珏舡轭麸痨弼屐ㄣ镱翦铘翎绌祜镳骘孱趄轭泔铘孱殒ㄡ钿扉篝孱趄篝蜷铉ㄣ狎孱趄翎绌泔祆邈孱趄┅ㄤ彐躅珏舡翦翎绌ㄩ扉篝翎绌戾è屐屙孱趔ㄣ滗翎绌┅祜镳骘屐屙孱轭屐屙孱趔泔祆邈ㄧ弭翦屐屙孱舂┅翎绌ㄤ彐躅骒狒翦飑ㄣ镱è铛祆飑紊泰è狒镯飑扉篝飑è扉篝飑磲疸犷＇骒狒翦飑┅ㄤ彐躅篝蜷翦舂篝蜷铉趄轫Ж＼羽徙＼葬＼五黛轭濠翦舂ㄤ彐躅屮趄徙舡翦ㄣ镱翦铘祜镳骘翦轭磲疸狎＇篝蜷ㄦ灬趑孱磲疸狎＇珏舡翦泔铘孱舂┅殒ㄡ钿翦戾铉翳翦舂癌泔祆邈翦舂ㄤ彐躅蝈盹鲥轭溴翦舂ㄣ镥蜚戾è滹铄紊泰ㄩ钿屮箦ㄣ镥蜚氨渤吹斗腹ъ轶舂┅祜镳骘汨狎徙翦轭ㄣ镥蜚翦ъ轶舂殒铒ㄦ轭汨狎徙翦轭溴箦舂滹箦赳滹铄冤殒滹铄泔祆邈汨狎徙翦颟篝蜷铉┅ㄤ彐躅黼糸綮翦舂篝蜷蝈盹鲥轭溴篝蜷翦舂┅ㄤ彐躅蝈徜糸綮瀛轭溴糸綮濠戾è轭溴箦ㄣ镥蜚氨渤吹斗腹ъ轶舂铛礅弪Ж┅ㄣ躜蝈铘铛礅弪癌祜镳骘汨狎徙翦轭ㄣ镥蜚篝蜷糸綮濠ъ轶舂躅糸铒ㄦ轭汨狎徙翦轭溴箦舂滹ㄩㄥ聃犰汨狎徙翦＼痱镧瘐箬沲蝌孱舡铛礅弪铛礅弪螬箦翩沲蝌孱舡铛礅弪癌箦翩沲蝌孱舡铛礅弪ǐí沲蝌孱舡铛礅弪卑ㄤ殓轸汨狎汨狎徙翦颟┅┅麒孱沲蝌孱舡铛礅弪癌瘐箬沲蝌孱舡铛礅弪铛礅弪螬蝈鲥蝮铛礅弪螬┅ㄤ彐躅轭沆蹁屦翦舂ㄡ钿戾铉翳翦舂辈篝蜷铉篚怏羼篝蜷翦舂辈轭沆蹁搴孩┅ㄤ彐躅骖犴瀛骝镯轭溴ㄩ钿屮麒孱戾铉翳轭溴癌ㄦ矧磲⒔浇狺ア轭溴ㄡ篌弪紊泰戾è骖犴ㄣ镥蜚ㄦ矧磲紊铂О溥ㄦ轵篝轭溴┅ъ轶舂┅祜镳骘铛轭篚怏羼轭溴暴滹箦赳骖犴ㄡ痧孱骖犴扉篝ㄣ镤瀛汨狎ǐō铛暴ㄣ栳颦泔溴＼岍┅┅┅ㄣ镥蜚骖犴篝蜷铉┅ㄤ彐躅盱蟓麸蝮盱痖钿屮ㄣ镱è篝蜷铉盱盱è狒镯盱紊泰è篝蜷铉ㄦ轵篝盱┅ㄣ镱è篝蜷铉ㄦ轵篝盱稷ㄡ痧孱磲疸狎ㄌ镣履ㄘ盱蟓麸蝮痖钿屮┅ㄣ滗盱┅Ж＼五黛轭濠┅è篝蜷铉ㄦ轵篝盱㈤ㄦ矧磲紊狺磲疸狎ㄌ镣履ㄘ盱蟓麸蝮痖钿屮┅ㄣ滗盱┅┅è篝蜷铉ㄦ轵篝盱㈣并戾舄è翦ㄦ矧磲紊狺ㄦ灬趑孱ㄧ弭翦盱┅┅糸綮黼糸綮翦舂ㄩ钿屮蝈徜糸綮瀛轭溴翦舂┅ㄩㄡ钿轭溴铒ㄥ聃犰轭溴痖钿屮┅戾铉翳轭溴戾铉翳痖钿屮┅ㄥ聃犰篚怏羼轭溴戾铉翳痖钿屮┅痖钿屮┅ㄦ矧磲紊ギ轭沆蹁搴岙蝮簪ㄦ钺礤骝镯轭溴轭溴┅痱镧ㄦ矧磲紊狺狺ア糸綮磲脲篝蜷铉戾铉翳糸綮濠洪铋糸犰屐屙孱ㄣ栳瘴呐姨晌庞戾铉翳轭溴┅┅┅┅è篝蜷铉ㄦ轵篝盱⑨戾è翦篝蜷ㄦ矧磲紊狺ㄦ灬趑孱磲疸狎ㄌ镣履ㄘ盱蟓麸蝮痖钿屮┅ㄣ滗盱┅┅┅麒孱戾铉翳翦舂癌ㄩㄩ钽祯溴翦舂翦痱镧戾è栩彐ㄧ弭轭麸痨弼屐箦泔钿盱㈣蝈姊┅麒孱戾铉翳栩彐癌箦翩ㄧ弭栳箬翦躺嗡粤绿弄箦泔钿ㄦ轵篝栩彐┅┅ㄦ矧磲紊⑧徉撷翦舂┅┅è扉篝盱磲疸狎ㄌ镣履ㄘ盱蟓麸蝮痖钿屮┅盱┅┅è扉篝盱磲疸狎ㄌ镣履ㄘ盱蟓麸蝮痖钿屮┅盱┅┅ㄤ彐躅珏舡泔铘孱疳珏戾è栩泔躅癌祜镳骘翎轭疳珏殒ㄡ钿扉篝翎绌篝蜷铉ㄦ轵篝翎绌篝蜷铉ㄦ轵篝翎绌㈣颌┅滹ㄩ钽栩泔躅舂殒ㄡ钿栩泔躅暴铒ㄡ钿扉篝翎绌篝蜷铉ㄦ轵篝翎绌篝蜷铉ㄦ轵篝翎绌㈣颌┅┅泔祆邈翎绌┅ㄤ彐躅疳蝮ㄦ钺礤鏖翳镳孱骈戾ㄦ骖犴濠戾è翦磲脲篝蜷铉ㄦ殪瀛戾铉翳姗┅蝈徜箦聃孱沐翦姗铒溴麸盱疳蝮瀛梏盱淡骝徵礤铘翦舂紊泰┅ㄤ彐躅疳蝮瀛疳珏é镳糸镱犰ㄦ钺礤⑵蝻铘蔑铘孱趔梏恝┅戾è骝镱舡泔铘孱疳蝮骖犴濠┅磲脲轭篝犷沐箴邈疳珏恒镱翦铘骝镱舡泔铘孱舂┅ㄤ彐躅蝈徜滹泱é镳糸镱犰疳翳┅祜镳骘轭扉篝溟蝈泗矧礤蜱瀛疳翳钺礤疳翳⒙镤┅泔祆邈戾è骖犴ㄦ殪瀛钺礤篝蜷铉姗疳珏疳蝮瀛疳珏姗┅扉篝疳珏骖犴濠┅ㄤ彐躅麸泗蝈箴邈滹泱戾è骟趄磲脲狎蜥Ж癌哄戾礤铘豉疱р狍瀛汨狎烘殪飙痫轭翦横潢躞翎忪舂┅鏖翳秕麴豸麸篝蜷铉骟趄换深溴钺礤戾舄è糸綮黼糸綮糸綮箴邈┅躅溴蜢轭磲脲篝蜷铉戾铉翳糸綮濠洪铋糸犰屐屙孱＼┅ㄦ矧磲狺狺狺ア躅溴蜢轭糸綮躅溴蜢轭濠ㄦ矧磲麸泗蝈搴喉狲溴痿韬侯蹴忮蝈浜换深溴泔铘孱趔戾è轭溴蝈徜糸綮瀛轭溴糸綮箴邈┅┅祜镳骘疳珏骖犴濠轭滹泱滹戾è疳珏轭溴蝈徜糸綮瀛轭溴糸綮疳珏┅┅麒孱ㄡ钿疳珏轭溴ō戾铉翳疳珏轭溴戾铉翳轭溴┅ㄥ聃犰篚怏羼疳珏轭溴戾铉翳轭溴┅轭溴┅ㄦ矧磲狺ア篚怏羼骖犴ō戾铉翳骖犴濠穿┅┅┅骟趄┅ㄤ彐躅痱轭舡滹泱ㄤ镢螬鏖翳镳孱骈戾ㄩ钿屮㈤钿屮蝮簪轰轵邈糸镱猴豸瘐舂ㄦ矧磲轭溴⒆屐泔礤麸蚂蹂羽邈滹沲礤铘狒轱睢浇浇浇浇浇浇浇浇浇浇浇浇浇浇浇浇浇浇蔑铘孱趔麸泗蝈搴喉狲溴痿韬侯蹴忮蝈浜祜镳骘箴邈骖犴濠轭滹泱滹戾è镱犴ㄦ矧磲紊岙蝮簪篚怏羼骖犴ō戾铉翳骖犴濠穿┅ㄤ屦翳戾铉翳蝈徜糸綮瀛轭溴糸綮箴邈┅┅换ㄦ矧磲狺ア骖犴镱犴濠鏖翳镳孱骈戾ㄦ镱犴轰轵邈糸镱猴豸瘐舂ㄩ矧溴痿暴麸泗蝈屦箴邈┅痱镧麒孱溴痿暴ㄦ矧磲轭溴狺ア篚怏羼骖犴ō戾铉翳骖犴濠穿┅ㄦ矧磲幄篝蜷麸泗蝈箴邈滹泱┅┅ㄦ矧磲幄篝蜷蝮箴邈┅┅换族ъ箅轲翳扉铍狒翳轶痫轭换ㄦ矧磲ギ轭沆蹁搴扉铍螽蝮簪┅┅鏖翳镳孱骈戾扉铍㈧轭塍蝮簪轰轵邈糸镱猴豸瘐舂ㄦ矧磲扉铍ア祜镳骘脲忮轭翳栳箬脲镦躺嗡粤绿弄躞轭ㄨ狍璀鲠祯鲠祯濠滹ㄦ矧磲扉铍唼岷狺ア脲鲠祯濠┅ㄤ彐躅蝈祜徜滹泱ㄤ镢螬祜镳骘箴邈骖犴濠轭滹泱泔祆邈扉篝磲脲轭篝犷沐箴邈疳珏恒镱翦铘蜥箴邈┅骖犴濠┅